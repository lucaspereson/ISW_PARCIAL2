name: Test, Build and Deploy
# run-name: ${{ github.actor }} activo el flujo de trabajo
on:
  push:
    branches:
      - main
    paths-ignore:
      - ".github/**"
  pull_request:
    branches:
      - main
    paths-ignore:
      - ".github/**"

jobs:
  Test:
    name: Test
    runs-on: ubuntu-latest 
    # if: github.event_name == 'pull_request' && github.ref == 'refs/heads/main' 
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
         node-version: 16.18 
         
      - name: Install dependencies
        run:  | 
              npm ci 
              npm install eslint eslint-plugin-react --save-dev
              npm install @babel/cli @babel/core @babel/preset-env --save-dev
              npm install --save-dev jest # Test
              npm install nodemailer --save #Feedback
              
      - name: Run tests
        run:  npx jest

      #- name: Build 
      #  run:  npm run build
  
      #NotificacionTestSlack:
      - name: Envio de notificacion Slack - Test
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        if: ${{ failure() }}
        with:
          status: ${{ job.status }}
          text: |
                ¡Atención! Los tests fallaron. Commit no fusionado en el repositorio.
                Autor: ${{ github.actor }}
                Commit: ${{ github.sha }}
                Mensaje: ${{ github.event.head_commit.message }}
          channel: #canal-de-difusion-repositorio

  sonarcloud:
    name: SonarCloud
    needs: [Test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  Deploy:
    name: Build and Deploy
    needs: [Test] 
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' 
    # el job de deploy solo se ejecuta cuando el evento sea un push en la rama "main" y no se ejecute para las pull requests.
    steps:
      - name: Deploy to production
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.SERVICE_ID}}
          api-key: ${{ secrets.RENDER_API_KEY}}

      #NotificacionDeploySlack:
      - name: Envio de notificacion Slack - Deploy
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        with:
          status: ${{ job.status }}
          text: |
                  Se ha realizado un push en el repositorio, y se ha desplegado una nueva version.
                  Autor: ${{ github.actor }}
                  Commit: ${{ github.sha }}
                  Mensaje: ${{ github.event.head_commit.message }}
          channel: #canal-de-difusion-repositorio